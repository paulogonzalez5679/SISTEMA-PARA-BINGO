<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Bingo Master</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0d46f2",
                        "background-light": "#f5f6f8",
                        "background-dark": "#101422",
                        "foreground-light": "#111827",
                        "foreground-dark": "#f9fafb",
                        "card-light": "#ffffff",
                        "card-dark": "#1f2937",
                        "border-light": "#e5e7eb",
                        "border-dark": "#374151",
                        "selected-yellow": "#facc15",
                        "selected-blue": "#3b82f6",
                        "neutral-circle-light": "#e5e7eb",
                        "neutral-circle-dark": "#374151"
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .bingo-ball {
            transition: all 0.2s ease-in-out;
        }
        .bingo-ball.yellow-ball {
            background-color: #facc15;
            color: #111827;
        }
        .bingo-ball.blue-ball {
            background-color: #3b82f6;
            color: #111827;
        }
        .bingo-ball.selected-yellow,
        .bingo-ball.selected-blue {}
        .bingo-ball:not(.selected-yellow):not(.selected-blue) {}
        .dark .bingo-ball:not(.selected-yellow):not(.selected-blue) {}
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-foreground-light dark:text-foreground-dark">
<div class="flex flex-col min-h-screen">
<main class="flex-grow container mx-auto p-4 sm:p-6 md:p-8">
<div class="text-center mb-8">
<h1 class="text-4xl sm:text-5xl font-bold text-primary">Bingo UETS</h1>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
<div class="md:col-span-2 bg-card-light dark:bg-card-dark p-6 rounded-lg shadow-md">
<h2 class="text-2xl font-bold mb-6 text-center">Tablero Maestro</h2>
<div class="grid grid-cols-5 gap-2 sm:gap-4">
<div class="flex flex-col items-center">
<div class="text-center font-bold text-4xl text-primary mb-4">B</div>
<div class="space-y-2 flex flex-col items-center" id="b-column"></div>
</div>
<div class="flex flex-col items-center">
<div class="text-center font-bold text-4xl text-primary mb-4">I</div>
<div class="space-y-2 flex flex-col items-center" id="i-column"></div>
</div>
<div class="flex flex-col items-center">
<div class="text-center font-bold text-4xl text-primary mb-4">N</div>
<div class="space-y-2 flex flex-col items-center" id="n-column"></div>
</div>
<div class="flex flex-col items-center">
<div class="text-center font-bold text-4xl text-primary mb-4">G</div>
<div class="space-y-2 flex flex-col items-center" id="g-column"></div>
</div>
<div class="flex flex-col items-center">
<div class="text-center font-bold text-4xl text-primary mb-4">O</div>
<div class="space-y-2 flex flex-col items-center" id="o-column"></div>
</div>
<script>
                            const columns = {
                                'b-column': {
                                    start: 1,
                                    end: 15
                                },
                                'i-column': {
                                    start: 16,
                                    end: 30
                                },
                                'n-column': {
                                    start: 31,
                                    end: 45
                                },
                                'g-column': {
                                    start: 46,
                                    end: 60
                                },
                                'o-column': {
                                    start: 61,
                                    end: 75
                                }
                            };
                            let isYellow = true;
                            for (const colId in columns) {
                                const container = document.getElementById(colId);
                                const {
                                    start,
                                    end
                                } = columns[colId];
                                for (let i = start; i <= end; i++) {
                                    const ball = document.createElement('div');
                                    ball.textContent = i;
                                    ball.className = 'bingo-ball flex items-center justify-center size-10 rounded-full font-semibold text-lg cursor-pointer hover:opacity-80';
                                    if (isYellow) {
                                        ball.classList.add('yellow-ball');
                                    } else {
                                        ball.classList.add('blue-ball');
                                    }
                                    isYellow = !isYellow;
                                    container.appendChild(ball);
                                }
                            }
                        </script>
</div>
</div>
<div class="md:col-span-1 space-y-8">
<div class="bg-card-light dark:bg-card-dark p-6 rounded-lg shadow-md">
<h3 class="text-xl font-bold mb-4 text-center">Progreso de Tablas</h3>
<ul class="space-y-3"></ul>
</div>
<button class="w-full bg-primary text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg hover:bg-primary/90 transition-colors duration-300 transform hover:scale-105">
                        Nuevo Juego
                    </button>
<script>
document.querySelector('button').addEventListener('click', async () => {
    // Llama al endpoint Flask para reiniciar
    await fetch('/reset', {method: 'POST'});
    // Limpia el estado local
    masterState = Array(76).fill(false);
    cards.forEach(card=>{card.marks=Array(5).fill().map(()=>Array(5).fill(false)); card.won=false; card.aciertos=0;});
    actualizarBolas();
    actualizarProgreso();
});
</script>
</div>
</div>
</main>
</div>
<script>
        // --- LÓGICA BINGO MASTER ---
        let cards = [];
        let masterState = Array(76).fill(false); // 1-75

        // Cargar JSON de cartones
        async function cargarCartones() {
            // Usar endpoint Flask para obtener el último JSON generado
            const resp = await fetch('/get_cards');
            cards = await resp.json();
        }

        // Marcar/desmarcar bola
        async function marcarBola(num, marcado=true) {
            masterState[num] = marcado;
            actualizarBolas();
            // Enviar el número marcado/desmarcado al backend para actualizar el JSON
            await fetch('/mark', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({num, marcado})
            });
            // Actualizar el progreso y ganadores en tiempo real
            actualizarProgreso();
        }

        // Actualiza el color de las bolas
        function actualizarBolas() {
            document.querySelectorAll('.bingo-ball').forEach(ball => {
                const num = parseInt(ball.textContent);
                if (masterState[num]) {
                    ball.style.background = '#111827';
                    ball.style.color = '#fff';
                } else {
                    ball.style.background = ball.classList.contains('yellow-ball') ? '#facc15' : '#3b82f6';
                    ball.style.color = '#111827';
                }
            });
        }
        // Verifica ganadores y progreso
        function actualizarProgreso() {
            // Obtener progreso y ganadores desde el backend
            fetch('/progress')
                .then(resp => resp.json())
                .then(data => {
                    const ul = document.querySelector('.space-y-3');
                    ul.innerHTML = '';
                    (data.top3 || []).forEach(tabla => {
                        ul.innerHTML += `<li class="flex items-center justify-between p-3 rounded-lg bg-background-light dark:bg-background-dark">
                        <span class="font-semibold text-lg">${tabla.serial}</span>
                        <span class="font-medium text-lg ${tabla.won?'text-green-600':'text-primary'}">${tabla.aciertos} aciertos${tabla.won?' (GANADOR)':''}</span>
                        </li>`;
                    });
                    // Si hay ganadores, generar PDF comprobante
                    if (data.ganadores.length) {
                        data.ganadores.forEach(g => {
                            fetch('/winner_pdf', {
                                method: 'POST',
                                headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({serial: g.serial})
                            });
                        });
                    }
                });
        }

        // Verifica si un cartón es ganador
        function checkGanador(marks) {
            if (!marks) return false;
            for (let i=0;i<5;i++) {
                if (marks[i].every(x=>x)) return true;
                if ([0,1,2,3,4].every(r=>marks[r][i])) return true;
            }
            if ([0,1,2,3,4].every(i=>marks[i][i])) return true;
            if ([0,1,2,3,4].every(i=>marks[i][4-i])) return true;
            return false;
        }

        // Genera PDF de ganador (llama a endpoint Flask)
        async function generarPDFGanador(serial) {
            await fetch('/winner_pdf', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({serial})
            });
        }

        // Reiniciar juego
        function reiniciarJuego() {
            masterState = Array(76).fill(false);
            cards.forEach(card=>{card.marks=Array(5).fill().map(()=>Array(5).fill(false)); card.won=false; card.aciertos=0;});
            actualizarBolas();
            actualizarProgreso();
        }

        // Eventos de bolas
        document.querySelectorAll('.bingo-ball').forEach(ball => {
            ball.addEventListener('click', () => {
                const num = parseInt(ball.textContent);
                if (!masterState[num]) marcarBola(num, true);
            });
            ball.addEventListener('dblclick', () => {
                const num = parseInt(ball.textContent);
                if (masterState[num]) marcarBola(num, false);
            });
        });

        // Botón de reinicio
        document.querySelector('button').addEventListener('click', reiniciarJuego);

        // Inicializar
        cargarCartones().then(()=>{
            actualizarBolas();
            actualizarProgreso();
        });
    </script>
</body></html>